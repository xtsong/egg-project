### Egg.js综述

## egg 在阿里的定位

egg 也是这一时代洪流中的新生一员，它面向的领域是：企业级的 web 基础框架。

2013 年蚂蚁的 chair 框架，可以视为 egg 的前身。
2015 年 11 月，在苏千的召集下，阿里各 BU 的前端骨干齐聚黄龙，闭门共建。
2016 年初，各 BU 的基础 web 框架完成升级，在同一套规范的基础上进行差异化定制。
2016 年中，广泛使用在绝大部分阿里的前端 Node.js 应用。
2016 年 09 月，在 JSConf China 2016 上亮相并宣布开源。
2017 年初，官网文档 https://eggjs.org/ 亮相，并发布 egg@1.0 版本。


有哪些人参与到 egg 的开发和维护中？
  核心开发者中，贯高(popomore, 小substack)，苏千(Python发烧友)，死马等人，是开源社区的资深人士，每个人维护的 npm 模块都有几百个，同时也是 cnpm 和 koa 的核心开发者。

我们甚至还有 2 位前端安全方向的专家，负责 egg-security 等类库。
阿里各 BU 的前端活跃开发者，光框架和插件的维护者就超过 40 位。
外部开发者也不少，甚至还有几位硅谷华人开发者在帮我们翻译文档。

蚂蚁金服，天猫，UCWeb，村淘，神马，语雀等 BU 的业务场景千差万别，但他们的基础框架都是在 egg 之上扩展的，遵循的是同一套规范。
egg 的设计机制，使得我们在遵循同一套规范的同时，完美的达成生态共建和差异化定制的平衡点。
egg 里面只有我们对企业级应用的最佳实践，而并没有耦合任何阿里的具体业务逻辑。


## egg 的设计理念

Think about future, Design with flexibility, But only implement for production.

# 约定优于配置
一个大规模团队的基础框架，最重要的是需要遵循一定的约束和约定。

没有约定的团队，沟通成本是非常高的，比如有人会按目录分栈而其他人按目录分功能，开发者认知不一致很容易犯错。通过约定可以减少开发人员的学习成本，开发人员不再是『钉子』，可以流动起来。

egg 最核心的东西，其实就是一套约定和规范，这个规范不仅仅是开发目录的约定，还包括了开发过程中，从提案讨论，编码风格，code review 等等方方面面的规范化。

源于我们在大规模企业级应用中的经验沉淀，它们的产出物就是各种约定和插件。
我们的文档，包含了非常多的框架设计思路，即使你不用 egg，也可以看看，如：
单元测试
多进程模型
日志
然后就是类似 egg 团队这种基于 gitlab/github 的硬盘式协作模式，以及在 issue 中的各种讨论，后来的开发者可以轻而易举的了解某个设计思路的前因后果。
egg-core 的讨论
重新梳理 csrf
重构 messenger
egg-scripts 部署脚本
cluster-client pr 与 增强多进程研发模式
当然，我们推荐基于 egg 来定制上层框架：

egg 采用微核 + 插件体系，本身大部分功能由插件提供，高度灵活，功能强大。
egg 提供了完善的加载机制实现 - loader，也是整个框架的灵魂，并且支持非常多的扩展方式。
约定不等于扩展性差，相反 egg 有很高的扩展性。
对于团队架构师或技术负责人，它足够的 optional，只需简单的做加法，组装插件即可。
对于团队开发人员，它又足够的强约束，保证不会出现千人千面的代码风格和设计。
某种意义上来讲，egg 也是渐进式的框架，参见 egg 文档 - 渐进式开发。
# 插件机制
插件机制是 egg 的一大特色，它不但可以保证框架核心的足够精简、稳定、高效，还可以促进业务逻辑的复用，生态圈的形成。
经典范例如 egg-security，就集合了阿里集团的多年安全经验积累，具体可以看下 egg 文档 - 安全。
同时，差异化定制不意味着没有约定，它只是下层插件实现的差异化，而上层开发体验是一致的：

如 egg-view-nunjucks / egg-view-react 这类插件，遵循 模板插件开发规范 的同时，又不限制具体模板引擎选项。仅需安装不同的 view 插件， 上层开发体验是一致的。

如 egg 文档 - 插件 中提到的 mysql 等的实例化方式，只要是开发中共性的模式，都会被不断的总结和沉淀下来成为约定。
egg-tracer / egg-userrole 这些约定，等等，无处不在。
# 框架机制
上面提到的插件机制，很灵活，但是对于企业级应用来说，却还不够。

统一的技术选型，比如数据库、模板、前端框架及各种中间件设施都需要选型，而框架封装后保证应用使用一套架构。
统一的默认配置，开源社区的配置可能不适用于公司，而又不希望应用去配置。
统一的部署方案，通过框架和平台的双向控制，应用只需要关注自己的代码。
统一的代码风格，框架不仅仅解决代码重用问题，还可以对应用做一定约束，作为企业框架是很必要的。egg 在 koa 基础上做了很多约定，框架可以使用 Loader 自己定义代码规则。
为此，egg 为团队架构师和技术负责人提供 框架定制 的能力，框架是一层抽象，可以基于 egg 去封装上层框架，并且 egg 支持多层继承。

+-----------------------------------+--------+
|      app1, app2, app3, app4       |        |
+-----+--------------+--------------+        |
|     |              |  framework3  |        |
+     |  framework1  +--------------+ plugin |
|     |              |  framework2  |        |
+     +--------------+--------------+        |
|                   egg             |        |
+-----------------------------------+--------|
|                   koa                      |
+-----------------------------------+--------+
这样，整个团队就可以遵循统一的方案，并且在项目中可以根据业务场景自行使用插件做差异化，当后者验证为最佳实践后，就能下沉到框架中，其他项目仅需简单的升级下框架的版本即可享受到。

# 质量保障和技术支撑
egg 所有的核心代码和插件，都有 93+% 的覆盖率的单元测试。参见 egg 文档 - 单元测试。
规范的 github pull request 协作模式，每一次提交都会经过自动化集成测试，以及 2+ 个核心开发者的 review。
严格遵循 semver 版本发布规则，可以放心的使用 ^ 引入我们的模块。
提供了 egg-bin，npm install 等等开发期的辅助功能，让开发者更愉悦的进行开发。
内网版的 egg 是继承于社区版的，大部分问题，我们能第一时间感知到并及时修复。
技术支撑方面，在前面第三节里面也提到了，我们有非常多且活跃的开发者，以及内部的广泛使用，并不会没人维护。
# 其他
与其他框架的对比
其实不是一个层面的，sails , hapi 这些框架，通过 egg + 对应的插件封装成上层框架，就一样了。

egg 与 koa 的关系
koa 是一个非常优秀的框架，然而对于企业级应用来说，它还比较基础，而 egg 选择了 koa 作为其基础框架，在它的模型基础上，进一步对它进行了一些增强。
egg 的核心开发者即为 koa 的核心开发者